
import config from "../config";

import geoJSONParser from "./geojson-parser";


const amenities = config.amenities;

const boundingCoordinates = config.boundingCoordinates;

export default class queryBuilder {

	constructor(options){

		this.json = options.json;
		
		this.query = "";

		this.headGenerator = (query)=>{
			return query + "[out:" + this.json.requestConfig.dataType + "][timeout:" + this.json.requestConfig.timeout + "]; ";
		}

		this.bodyGenerator = (query)=>{
			
			var filters = "";
			var tags = this.json.tags;

			for (var tag in tags) {

				if(!Number.isInteger(tags[tag])){
					filters = filters + '["' + tag + '"~"' + (tag === 'amenity' ? amenities[this.json.tags[tag]] : tags[tag]  ) + '"]';	
				}else{
					filters = filters + '["' + tag + '"]';	
				}
			}

			
			// var poly = geojsonparser.parse();
			if(this.json.ward !== undefined){
				var geojsonparser = new geoJSONParser('wards');
				var poly = geojsonparser.parseWards(this.json.ward);
			}else{
				var geojsonparser = new geoJSONParser('pokhara-geojson');
				var poly = geojsonparser.boundingBox();
			}


			// var poly = '(poly:"28.17442893981928 83.97787475585943 28.175050735473746 83.97489166259777 28.177286148071346 83.97464752197271 28.180021286010742 83.97067260742199 28.179771423339957 83.96421051025402 28.182382583618164 83.96395874023443 28.184867858886776 83.96072387695318 28.183128356933594 83.95861816406256 28.18387413024908 83.95687866210943 28.183002471923828 83.9546356201173 28.18598556518566 83.95326995849615 28.185489654541016 83.95066070556652 28.188098907470817 83.95091247558594 28.186855316162166 83.9483032226563 28.187601089477596 83.9470596313476 28.191453933715934 83.94755554199224 28.194932937622013 83.94618988037115 28.194437026977596 83.94941711425781 28.191701889038143 83.95326995849615 28.194063186645565 83.95774841308588 28.195430755615234 83.9578704833985 28.19306945800787 83.96122741699219 28.193317413330078 83.96544647216803 28.190832138061467 83.96731567382812 28.19319343566906 83.96967315673834 28.197046279907227 83.97029876708996 28.201395034790153 83.96595001220697 28.201271057128963 83.96308898925776 28.20313644409191 83.96234130859375 28.202390670776424 83.95811462402355 28.204999923706055 83.9560012817384 28.20649147033697 83.95265197753906 28.20586967468273 83.9505386352539 28.207733154296875 83.95004272460943 28.208976745605582 83.94805145263672 28.207983016967887 83.94481658935547 28.21245574951172 83.94370269775396 28.212705612182674 83.93848419189447 28.213947296142635 83.93872833251953 28.214817047119084 83.93748474121105 28.21245574951172 83.93437957763678 28.21556282043457 83.93202209472656 28.218297958373967 83.93313598632807 28.218545913696403 83.9350051879884 28.217178344726676 83.93637084960949 28.22003746032715 83.9369888305664 28.22513198852539 83.93649291992193 28.227493286132926 83.93761444091803 28.226871490478516 83.94469451904303 28.225008010864315 83.94767761230469 28.22314453125 83.94792938232428 28.22339248657238 83.95004272460943 28.220657348632812 83.95202636718744 28.220533370971793 83.95613098144537 28.221529006958065 83.9573745727539 28.220285415649528 83.95848846435558 28.220783233642578 83.95973205566412 28.216556549072266 83.96172332763683 28.221155166626033 83.96830749511724 28.220783233642578 83.97129058837885 28.229232788085938 83.97874450683594 28.226747512817496 83.97986602783197 28.227121353149528 83.98110961914068 28.22513198852539 83.98247528076178 28.2303524017334 83.98409271240234 28.23494911193859 83.98160552978516 28.239175796508903 83.98458862304699 28.243524551391715 83.9808578491211 28.24576187133789 83.97265625 28.248123168945312 83.9752655029298 28.249986648559627 83.97551727294922 28.251850128173828 83.97154235839844 28.25607681274414 83.96830749511724 28.26141929626465 83.97154235839844 28.260177612304688 83.97303009033203 28.262289047241268 83.97563934326183 28.268627166748047 83.97874450683594 28.270492553710994 83.97824859619146 28.271238327026424 83.98222351074219 28.275711059570426 83.98483276367182 28.27459335327154 83.98719787597662 28.27111244201666 83.98471069335943 28.26775741577154 83.98421478271496 28.26775741577154 83.98632812500011 28.264030456543026 83.98744964599621 28.26241493225109 83.99166870117199 28.260549545288143 83.992172241211 28.258438110351562 83.98694610595703 28.255826950073356 83.9862060546875 28.253963470458984 83.98980712890625 28.24265480041504 83.99875640869135 28.239671707153377 83.99726104736328 28.231222152710075 84.0012435913086 28.227245330810547 84.00459289550787 28.215190887451286 84.00907135009766 28.21556282043457 84.0103149414063 28.21891784667963 84.00968933105469 28.220161437988338 84.01168060302746 28.22264671325695 84.01055908203136 28.22612571716303 84.01391601562506 28.224262237548885 84.02361297607422 28.22227287292492 84.02373504638666 28.21817207336437 84.02100372314459 28.21568679809576 84.02211761474615 28.218297958373967 84.02982330322277 28.216556549072266 84.03205871582037 28.210840225219783 84.02920532226568 28.208976745605582 84.03069305419928 28.206987380981445 84.02634429931646 28.20574569702154 84.02609252929688 28.200649261474723 84.02746582031256 28.19878578186035 84.02970123291016 28.196548461914176 84.0289535522461 28.195182800293026 84.03044128417969 28.192323684692383 84.02957153320318 28.1884708404541 84.0310668945313 28.185115814208984 84.02907562255854 28.17703819274908 84.03603363037115 28.17119789123541 84.03616333007812 28.169458389282283 84.03827667236328 28.16672325134283 84.03653717041016 28.16386604309082 84.03765106201183 28.161628723144588 84.03665924072277 28.160137176513672 84.0383987426759 28.156036376953125 84.03964233398443 28.15504264831543 84.03181457519531 28.15628433227539 84.03069305419928 28.159143447875977 84.03181457519531 28.161006927490348 84.03031921386724 28.158023834228516 84.02696228027355 28.157899856567496 84.02510070800781 28.16299438476574 84.02211761474615 28.160013198852653 84.01640319824224 28.160013198852653 84.01354217529303 28.162498474121094 84.01006317138672 28.16349220275879 84.00347900390636 28.167842864990348 84.00061798095714 28.168338775634766 83.99713897705084 28.17256355285656 83.99403381347656 28.172813415527344 83.98943328857422 28.171569824218864 83.98707580566418 28.17355918884283 83.98446655273438 28.17442893981928 83.97787475585943")';
			
			// query = query + "(poly:"+poly+");";
			// return query;
			
			query = query + "(";
			this.json.featureTypes.forEach(function(featureType) {
				query = query + featureType + filters + poly + ";"
			})
			query = query + "); ";
			return query;
		}

		this.tailGenerator = (query)=>{
			return query + "out body;" +
				">; " +
				"out skel qt;"
		}
	}

	build() {

		this.query = this.headGenerator(this.query);
		this.query = this.bodyGenerator(this.query);
		this.query = this.tailGenerator(this.query);

		return this.query;

	}
}